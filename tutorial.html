<!DOCTYPE html>
<html>
  <head>
    <title>Weather Layer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
  	<link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"></link>
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
  	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>

    <div id="map"></div>
    
    <div class = "col-md-4 col-md-offset-1">
  		<label for = "name">Location:</label>
  		<input type = "text" id = "location" placeholder = "Input location"/>
  	</div>
  
  	<div class = "col-md-4">
  		<label for = "date">Date and time: </label>
  		<input type = "datetime-local" id = "date"/>
  	</div>
  
  	<div class = "col-md-3">
  		<button type = "submit" class = "btn btn-success" id = "submit">Get Weather</button>
  	</div>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAVreCBSRR9nSVilsp4bfFUSyWHLaZVNy8&signed_in=true&callback=initMap" async defer></script>
    <script>
    	var map;
		function initMap() {
		  var submit = document.getElementById('submit');
		  var mapDiv = document.getElementById('map');
		  map = new google.maps.Map(mapDiv, {
		    zoom: 8,
		    center: new google.maps.LatLng(-34.397, 150.644)
		  });
		
		  // We add a DOM event here to show an alert if the DIV containing the
		  // map is clicked.
		  google.maps.event.addDomListener(submit, 'click', function() {
			  var location = document.getElementById('location').value;
			  var date = document.getElementById('date').value;
			  var requestString = "http://api.openweathermap.org/data/2.5/weather?q="
					  + location 
					  + "&appid=44db6a862fba0b067b1930da0d769e98";
			  var request = new XMLHttpRequest();
			  request.onload = function() {
				    map.data.forEach(function(feature) {
				        map.data.remove(feature);
				    });
				    var results = JSON.parse(this.responseText);
				    map.setCenter(new google.maps.LatLng(results.coord.lat, results.coord.lon));
				    map.data.addGeoJson(jsonToGeoJson(results));
			  };
			  request.open("get", requestString, true);
			  request.send();
		  });
		}
		
	  // For each result that comes back, convert the data to geoJSON
	  var jsonToGeoJson = function (weatherItem) {
	    var feature = {
	      type: "Feature",
	      properties: {
	        city: weatherItem.name,
	        weather: weatherItem.weather[0].main,
	        temperature: weatherItem.main.temp,
	        min: weatherItem.main.temp_min,
	        max: weatherItem.main.temp_max,
	        humidity: weatherItem.main.humidity,
	        pressure: weatherItem.main.pressure,
	        windSpeed: weatherItem.wind.speed,
	        windDegrees: weatherItem.wind.deg,
	        windGust: weatherItem.wind.gust,
	        icon: "http://openweathermap.org/img/w/"
	              + weatherItem.weather[0].icon  + ".png",
	        coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
	      },
	      geometry: {
	        type: "Point",
	        coordinates: [weatherItem.coord.lon, weatherItem.coord.lat]
	      }
	    };
	    // Set the custom marker icon
	    map.data.setStyle(function(feature) {
	      return {
	        icon: {
	          url: feature.getProperty('icon'),
	          anchor: new google.maps.Point(25, 25)
	        }
	      };
	    });
	    // returns object
	    return feature;
	  };
    </script>
  </body>
</html>